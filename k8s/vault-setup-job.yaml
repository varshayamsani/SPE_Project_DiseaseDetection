apiVersion: batch/v1
kind: Job
metadata:
  name: vault-setup
  namespace: disease-detector
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: vault-setup
        image: hashicorp/vault:1.15
        command:
        - /bin/sh
        - -c
        - |
          set +e  # Don't exit on policy creation failure
          echo "=========================================="
          echo "Configuring Vault from within cluster..."
          echo "=========================================="
          
          VAULT_ADDR="http://vault.disease-detector.svc.cluster.local:8200"
          VAULT_TOKEN="root-token-12345"
          export VAULT_ADDR
          export VAULT_TOKEN
          
          # Wait for Vault to be ready
          echo "Waiting for Vault API..."
          for i in $(seq 1 30); do
            if vault status > /dev/null 2>&1; then
              echo "✅ Vault is ready"
              break
            fi
            echo "  Attempt $i/30 - Waiting for Vault..."
            sleep 2
          done
          
          # Enable KV v2 secrets engine
          echo ""
          echo "Enabling KV v2 secrets engine..."
          if vault secrets list | grep -q "disease-detector/"; then
            echo "  ℹ️  KV secrets engine already enabled"
          else
            vault secrets enable -path=disease-detector kv-v2 && echo "  ✅ KV secrets engine enabled" || echo "  ⚠️  Failed to enable"
          fi
          
          # Store application secrets
          echo ""
          echo "Storing application secrets..."
          vault kv put disease-detector/app \
            flask_env=production \
            log_level=INFO \
            elasticsearch_host=elasticsearch.disease-detector.svc.cluster.local \
            elasticsearch_port=9200 \
            database_path=/app/data/patients.db \
            cors_origins="http://disease-detector-frontend.disease-detector.svc.cluster.local,http://localhost:3000" && \
            echo "  ✅ Application config stored" || echo "  ⚠️  Failed to store app config"
          
          vault kv put disease-detector/database \
            path=/app/data/patients.db \
            type=sqlite && \
            echo "  ✅ Database config stored" || echo "  ⚠️  Failed to store database config"
          
          # Create policy
          echo ""
          echo "Creating Vault policy..."
          echo 'path "disease-detector/data/*" { capabilities = ["read"] }' | vault policy write disease-detector-policy - && \
            echo "  ✅ Policy created" || echo "  ⚠️  Failed to create policy (optional in dev mode)"
          
          echo ""
          echo "=========================================="
          echo "✅ Vault configuration complete!"
          echo "=========================================="
          echo ""
          echo "Verifying secrets..."
          vault kv get disease-detector/app || echo "⚠️  Could not verify secrets"
        env:
        - name: VAULT_ADDR
          value: "http://vault.disease-detector.svc.cluster.local:8200"
        - name: VAULT_TOKEN
          value: "root-token-12345"

