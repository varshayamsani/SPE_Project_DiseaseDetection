---
# Kubernetes role: Deploy application to Kubernetes using Ansible
# This role uses kubectl commands wrapped in Ansible for deployment

- name: Check if kubectl is installed
  command: which kubectl
  register: kubectl_check
  changed_when: false
  failed_when: false

- name: Fail if kubectl is not installed
  fail:
    msg: "kubectl is not installed. Please install kubectl first."
  when: kubectl_check.rc != 0

- name: Verify Kubernetes cluster connection
  command: kubectl cluster-info
  register: cluster_info
  changed_when: false
  failed_when: false

- name: Display cluster information
  debug:
    msg: "{{ cluster_info.stdout }}"

- name: Create Kubernetes namespace
  command: kubectl create namespace {{ kubernetes_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  changed_when: true

- name: Apply Kubernetes manifests
  command: kubectl apply -f {{ playbook_dir }}/../../k8s/{{ item }} -n {{ kubernetes_namespace }}
  loop:
    - namespace.yaml
    - pvc.yaml
    - configmap.yaml
    - frontend-nginx-configmap.yaml
    - backend-service.yaml
    - frontend-service.yaml
    - backend-hpa.yaml
    - frontend-hpa.yaml
  register: apply_results
  changed_when: "'created' in apply_results.stdout or 'configured' in apply_results.stdout"

- name: Update backend deployment image
  command: kubectl set image deployment/disease-detector-backend backend={{ docker_image_backend }} -n {{ kubernetes_namespace }}
  register: backend_update
  changed_when: "'updated' in backend_update.stdout or 'unchanged' not in backend_update.stdout"
  failed_when: false

- name: Apply backend deployment if update failed
  command: kubectl apply -f {{ playbook_dir }}/../../k8s/backend-deployment.yaml -n {{ kubernetes_namespace }}
  when: backend_update.rc != 0
  register: backend_apply
  changed_when: "'created' in backend_apply.stdout or 'configured' in backend_apply.stdout"

- name: Update frontend deployment image
  command: kubectl set image deployment/disease-detector-frontend frontend={{ docker_image_frontend }} -n {{ kubernetes_namespace }}
  register: frontend_update
  changed_when: "'updated' in frontend_update.stdout or 'unchanged' not in frontend_update.stdout"
  failed_when: false

- name: Apply frontend deployment if update failed
  command: kubectl apply -f {{ playbook_dir }}/../../k8s/frontend-deployment.yaml -n {{ kubernetes_namespace }}
  when: frontend_update.rc != 0
  register: frontend_apply
  changed_when: "'created' in frontend_apply.stdout or 'configured' in frontend_apply.stdout"

- name: Wait for backend deployment rollout
  command: kubectl rollout status deployment/disease-detector-backend -n {{ kubernetes_namespace }} --timeout=5m
  register: backend_rollout
  changed_when: false

- name: Wait for frontend deployment rollout
  command: kubectl rollout status deployment/disease-detector-frontend -n {{ kubernetes_namespace }} --timeout=5m
  register: frontend_rollout
  changed_when: false

- name: Get backend deployment status
  command: kubectl get deployment disease-detector-backend -n {{ kubernetes_namespace }} -o jsonpath='{.status.readyReplicas}/{.spec.replicas}'
  register: backend_status
  changed_when: false

- name: Get frontend deployment status
  command: kubectl get deployment disease-detector-frontend -n {{ kubernetes_namespace }} -o jsonpath='{.status.readyReplicas}/{.spec.replicas}'
  register: frontend_status
  changed_when: false

- name: Display deployment status
  debug:
    msg: |
      Backend Deployment: {{ backend_status.stdout }} replicas ready
      Frontend Deployment: {{ frontend_status.stdout }} replicas ready
