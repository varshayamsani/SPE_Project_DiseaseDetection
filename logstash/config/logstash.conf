# Logstash Configuration for Disease Detector Application
# This configuration processes application logs and sends them to Elasticsearch

input {
  # Read log files from the application
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    type => "disease-detector"
  }
  
  # TCP input for direct log streaming
  tcp {
    port => 5044
    codec => json_lines
    type => "disease-detector"
  }
}

filter {
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }
  
  # Add hostname
  mutate {
    add_field => { "hostname" => "%{host}" }
  }
  
  # Parse log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }
  
  # Extract patient ID from logs if present
  if [message] =~ /patient_id/ {
    grok {
      match => { "message" => "patient_id[:\s]+%{WORD:patient_id}" }
    }
  }
  
  # Extract disease predictions
  if [message] =~ /prediction/ {
    grok {
      match => { "message" => "prediction[:\s]+%{WORD:disease}" }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "disease-detector-logs-%{+YYYY.MM.dd}"
    template_name => "disease-detector"
    template => "/usr/share/logstash/templates/disease-detector-template.json"
    template_overwrite => true
  }
  
  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }
}


